# Исправления в Homepage Editor

## Дата: 10/11/2025

## Выполненные исправления

### 1. Удаление главного видео из папки ✅

**Проблема:** При удалении главного видео через админку оно не удалялось из папки на сервере.

**Решение:** Проверена реализация - функционал уже работает корректно:
- В `HomeController.php` метод `deleteHeroVideo()` вызывает `HomeContent::cleanupOldVideo()`
- Метод `cleanupOldVideo()` в модели `HomeContent.php` удаляет файл через `Storage::delete()`
- При замене видео старый файл также автоматически удаляется

**Статус:** Функционал работает корректно, дополнительных изменений не требуется.

---

### 2. Добавление поддержки SVG изображений ✅

**Проблема:** 
- При добавлении изображений в секциях Hero, Контент, Услуги и Отзывы возникала ошибка "Ошибка сервера. Попробуйте позже"
- Не было поддержки SVG формата

**Решение:** Добавлена поддержка SVG во всех необходимых местах:

#### Backend (Laravel)

1. **HomepageContentController.php**
   - Обновлена валидация в методе `uploadImage()`: добавлен `svg` в список разрешённых форматов
   ```php
   'image' => 'required|image|mimes:jpeg,jpg,png,webp,svg|max:2048'
   ```

2. **HomeController.php**
   - Обновлена валидация в методе `uploadFallbackImage()`: добавлен `svg` в список разрешённых форматов

3. **HomeContent.php (модель)**
   - Добавлен `'image/svg+xml'` в метод `getAllowedImageMimeTypes()`
   - Обновлён `$mimeExtensionMap` в методе `validateFileIntegrity()`: добавлено `'image/svg+xml' => ['svg']`
   - Обновлён метод `validateFileExtension()`: добавлен `'svg'` в список валидных расширений для изображений
   - Обновлён метод `getFileValidationErrors()`: добавлен `'SVG'` в список разрешённых форматов в сообщении об ошибке

#### Frontend (Next.js)

1. **ImageUpload.tsx**
   - Добавлен `'image/svg+xml'` в константу `ACCEPTED_IMAGE_TYPES`
   - Добавлен `'.svg'` в константу `ACCEPTED_IMAGE_EXTENSIONS`
   - Обновлены сообщения об ошибках: "JPG, PNG, WEBP, SVG"
   - Обновлено информационное сообщение о форматах

2. **homepage-content.ts**
   - Добавлен `'image/svg+xml'` в массив `allowedTypes` в функции `uploadHomepageImage()`
   - Обновлено сообщение об ошибке: "JPG, PNG, WEBP, SVG"

---

## Технические детали

### Поддерживаемые форматы изображений
- **JPG/JPEG** - растровые изображения
- **PNG** - растровые изображения с прозрачностью
- **WEBP** - современный формат с хорошим сжатием
- **SVG** - векторные изображения (новое)

### Ограничения
- Максимальный размер изображения: **2 МБ**
- Максимальный размер видео: **50 МБ**

### Валидация
- **Клиентская сторона:** проверка типа файла и размера перед загрузкой
- **Серверная сторона:** полная валидация MIME-типа, расширения, размера и целостности файла

---

## Затронутые файлы

### Backend
1. `backend_laravel/app/Http/Controllers/Api/HomepageContentController.php`
2. `backend_laravel/app/Http/Controllers/Api/HomeController.php`
3. `backend_laravel/app/Models/HomeContent.php`

### Frontend
1. `frontend_next/src/components/admin/ImageUpload.tsx`
2. `frontend_next/src/lib/homepage-content.ts`

---

## Тестирование

### Рекомендуемые тесты:

1. **Загрузка SVG изображений:**
   - Загрузить SVG логотип в секцию Hero
   - Загрузить SVG иконки в секцию Услуги
   - Загрузить SVG логотипы клиентов в секцию Контент

2. **Загрузка других форматов:**
   - Проверить загрузку JPG, PNG, WEBP изображений
   - Убедиться, что все форматы работают корректно

3. **Валидация:**
   - Попробовать загрузить файл больше 2 МБ (должна быть ошибка)
   - Попробовать загрузить неподдерживаемый формат (должна быть ошибка)

4. **Удаление видео:**
   - Загрузить главное видео
   - Удалить его через админку
   - Проверить, что файл удалён из папки `storage/app/public/home/hero-videos/`

---

## Безопасность

Все изменения сохраняют существующие меры безопасности:
- Валидация MIME-типов на сервере
- Проверка расширений файлов
- Ограничение размера файлов
- Защита от path traversal атак
- Проверка целостности файлов

---

## Совместимость

- ✅ Не нарушена существующая функциональность
- ✅ Сохранена вёрстка и дизайн
- ✅ Не влияет на скорость загрузки
- ✅ Не влияет на SEO
- ✅ Обратная совместимость с существующими изображениями

---

## Примечания

- SVG файлы не проходят оптимизацию изображений (это нормально для векторной графики)
- SVG файлы должны быть безопасными и не содержать вредоносного кода
- Рекомендуется использовать SVG для логотипов и иконок, где важна масштабируемость
