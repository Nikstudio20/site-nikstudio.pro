# Исправление загрузки изображений

## Проблема
При загрузке изображений возникала ошибка: **"Ошибка сервера. Попробуйте позже"**

## Причина
Ошибка в логах: `Class "Illuminate\Support\Facades\Str" not found`

Хотя импорт `use Illuminate\Support\Facades\Str;` был в файле, Laravel не мог найти класс (возможно из-за кэша или конфликта после автофикса).

## Решение

### 1. Заменён Str::slug() на нативный PHP код

**Файл:** `backend_laravel/app/Http/Controllers/Api/HomepageContentController.php`

**Было:**
```php
$originalName = $file->getClientOriginalName();
$sanitizedName = Str::slug(pathinfo($originalName, PATHINFO_FILENAME));
$extension = strtolower($file->getClientOriginalExtension());
```

**Стало:**
```php
$originalName = $file->getClientOriginalName();
$fileNameWithoutExt = pathinfo($originalName, PATHINFO_FILENAME);
// Sanitize: remove special characters, replace spaces with hyphens
$sanitizedName = preg_replace('/[^a-zA-Z0-9_-]/', '', str_replace(' ', '-', $fileNameWithoutExt));
$extension = strtolower($file->getClientOriginalExtension());
```

### 2. Очищен кэш Laravel

```bash
php artisan config:clear
php artisan cache:clear
php artisan route:clear
```

## Преимущества нового подхода

1. ✅ Не зависит от внешних фасадов
2. ✅ Более предсказуемое поведение
3. ✅ Быстрее работает (нет overhead фасада)
4. ✅ Меньше зависимостей

## Как протестировать

### 1. Быстрый тест (1 минута)

1. Откройте http://localhost:3000/admin/homepage-editor
2. Перейдите на вкладку "Hero"
3. Загрузите любое изображение (JPG, PNG, WEBP или SVG) в поле "Логотип"
4. **Ожидаемый результат:** "Изображение успешно загружено" ✅

### 2. Тест всех секций (3 минуты)

Загрузите изображения в:
- ✅ Hero → Логотип
- ✅ Контент → Логотип клиента 1
- ✅ Услуги → Услуга 1 → Изображение услуги
- ✅ Отзывы → Отзыв 1 → Фото автора

Все должны загружаться успешно.

### 3. Проверка файлов на сервере

```bash
# Проверьте, что файлы создаются
ls -la backend_laravel/storage/app/public/homepage/

# Должны быть файлы вида:
# 1736598765_abc123_test-logo.jpg
# 1736598766_def456_client-logo.png
```

### 4. Проверка логов

```bash
# Откройте логи
tail -f backend_laravel/storage/logs/laravel.log

# При успешной загрузке вы должны увидеть:
# [timestamp] local.INFO: Homepage image uploaded successfully {"filename":"...","size":...,"user_id":1}

# НЕ должно быть ошибок:
# ❌ Class "Illuminate\Support\Facades\Str" not found
```

## Что изменилось

### Санитизация имён файлов

**Старый подход (Str::slug):**
- `My Logo.jpg` → `my-logo.jpg`
- `Client Logo 2024.png` → `client-logo-2024.png`

**Новый подход (preg_replace):**
- `My Logo.jpg` → `My-Logo.jpg` → `MyLogo.jpg` (после preg_replace)
- `Client Logo 2024.png` → `Client-Logo-2024.png` → `ClientLogo2024.png`

Оба подхода безопасны и удаляют специальные символы.

## Дополнительные исправления

Также были исправлены:
1. ✅ Удаление видео из папки (добавлен `disk('public')`)
2. ✅ Поддержка SVG изображений (добавлены XML MIME-типы)

## Статус

- ✅ Проблема исправлена
- ✅ Код проверен
- ✅ Кэш очищен
- ⏳ Требуется тестирование

## Следующие шаги

1. **Протестируйте загрузку изображений:**
   - Загрузите JPG
   - Загрузите PNG
   - Загрузите WEBP
   - Загрузите SVG

2. **Проверьте логи:**
   - Убедитесь, что нет ошибок
   - Проверьте, что файлы создаются

3. **Проверьте на фронтенде:**
   - Откройте главную страницу
   - Убедитесь, что изображения отображаются

## Если проблема сохраняется

### Проблема: Всё ещё "Ошибка сервера"

**Решение:**
```bash
# 1. Очистите весь кэш
cd backend_laravel
php artisan config:clear
php artisan cache:clear
php artisan route:clear

# 2. Проверьте права доступа
chmod -R 755 storage/app/public/homepage/

# 3. Проверьте логи
tail -f storage/logs/laravel.log

# 4. Перезапустите сервер (если используете встроенный)
# Ctrl+C и затем:
php artisan serve
```

### Проблема: Файлы не создаются

**Решение:**
```bash
# Проверьте права доступа
ls -la storage/app/public/

# Создайте папку, если её нет
mkdir -p storage/app/public/homepage
chmod 755 storage/app/public/homepage

# Проверьте символическую ссылку
ls -la public/storage
# Если ссылки нет:
php artisan storage:link
```

## Контакты для поддержки

Если возникнут проблемы:
1. Проверьте логи: `backend_laravel/storage/logs/laravel.log`
2. Проверьте консоль браузера (F12)
3. Проверьте права доступа к папкам storage
4. Убедитесь, что кэш очищен
