# Исправление внутренней страницы проектов

## Проблема
При работе с деталями проекта на странице `http://localhost:3000/admin/projects/[slug]` возникала ошибка:
```
SyntaxError: Unexpected token '<', "<!-- Pleas"... is not valid JSON
```

## Причина
Эта ошибка означает, что вместо JSON API возвращал HTML (обычно страницу ошибки 404 или страницу логина).

Причины:
1. **Использовался `fetch()` без токенов аутентификации**
2. Laravel API требует аутентификацию через `auth:sanctum` middleware
3. Без токена запрос возвращал 401/404, и Next.js отдавал HTML страницу ошибки
4. Попытка распарсить HTML как JSON приводила к ошибке

## Решение

### Исправленные функции в `frontend_next/src/app/admin/projects/[slug]/page.tsx`:

#### 1. Добавлен импорт apiClient
```typescript
import apiClient from "@/lib/api"
```

#### 2. Загрузка деталей проекта (fetchProjectDetail)

**❌ Было (fetch без токенов):**
```typescript
const response = await fetch(`${apiUrl}/api/projects/${resolvedParams.slug}`)
const data = await response.json()
```

**✅ Стало (apiClient с токенами):**
```typescript
const response = await apiClient.get(`/api/projects/${resolvedParams.slug}`)
const data = response.data
```

#### 3. Обновление деталей проекта (handleSave)

**❌ Было:**
```typescript
const response = await fetch(`${apiUrl}/api/projects/${resolvedParams.slug}/detail`, {
  method: 'PUT',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify(formData)
})
const data = await response.json()
```

**✅ Стало:**
```typescript
const response = await apiClient.put(`/api/projects/${resolvedParams.slug}/detail`, formData)
const data = response.data
```

#### 4. Создание деталей проекта (handleCreateDetail)

**❌ Было:**
```typescript
const response = await fetch(`${apiUrl}/api/projects/${resolvedParams.slug}/detail`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify(formData)
})
```

**✅ Стало:**
```typescript
const response = await apiClient.post(`/api/projects/${resolvedParams.slug}/detail`, formData)
const data = response.data
```

## Преимущества apiClient

1. **Автоматическая аутентификация** - токены добавляются автоматически
2. **Упрощенный код** - не нужно вручную:
   - Устанавливать заголовки
   - Сериализовать JSON
   - Парсить ответ
3. **Обработка ошибок** - автоматический редирект на логин при 401
4. **Обновление токенов** - автоматическое обновление истекающих токенов

## Почему возникала ошибка "not valid JSON"

### Цепочка ошибок:

1. `fetch()` без токена → запрос на `/api/projects/slug`
2. Laravel возвращает 401 Unauthorized
3. Next.js middleware перехватывает 401
4. Next.js возвращает HTML страницу (редирект на логин или 404)
5. Код пытается распарсить HTML как JSON: `await response.json()`
6. Ошибка: `SyntaxError: Unexpected token '<'`

### С apiClient:

1. `apiClient.get()` с токеном → запрос на `/api/projects/slug`
2. Laravel проверяет токен и возвращает JSON
3. apiClient автоматически парсит JSON
4. Данные доступны в `response.data`

## Тестирование

После исправления:
1. Перезапустите dev server
2. Откройте любой проект: `http://localhost:3000/admin/projects/[slug]`
3. Попробуйте:
   - ✅ Просмотр деталей проекта
   - ✅ Редактирование деталей (title, subtitle, client, year)
   - ✅ Создание деталей (если их еще нет)
   - ✅ Добавление hero media
   - ✅ Добавление блоков контента

Все операции должны работать без ошибок "not valid JSON".

## Что НЕ изменилось

- ❌ Дизайн и вёрстка
- ❌ Функциональность (только исправлена)
- ❌ Производительность
- ❌ SEO

## Связанные исправления

Аналогичные проблемы были исправлены в:
- ✅ Блог - список и детали (`/admin/blog`)
- ✅ Категории (`/admin/category`)
- ✅ Проекты - список (`/admin/projects`)
- ✅ Проекты - детали (`/admin/projects/[slug]`)

## Итог

Замена `fetch()` на `apiClient` решила проблему с "not valid JSON". Теперь все операции с деталями проектов работают корректно с правильной аутентификацией.
